<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Lade Anwendung...</title>
    <!-- Tailwind CSS CDN für modernes Design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Angepasste Schriftart und Fullscreen-Layout */
        body { font-family: 'Inter', sans-serif; }
        .full-screen-content { min-height: 100vh; width: 100%; }
        /* Platz für Header/Button lassen */
        .iframe-container {
            width: 100%;
            height: calc(100vh - 120px); 
            overflow: hidden;
            position: relative;
        }
        /* Style, um den iframe immer im Fullscreen des Containers zu halten */
        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 overflow-hidden">

    <!-- Ladebildschirm/Overlay (sollte schnell verschwinden) -->
    <div id="loading-view" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50 transition-opacity duration-300 opacity-100">
        <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4 text-lg font-medium text-gray-600">Lade Anwendung...</p>
    </div>

    <!-- 1. Passwort-Eingabeansicht -->
    <div id="password-view" class="hidden full-screen-content flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl border border-gray-100">
            <h1 class="text-3xl font-extrabold text-center text-indigo-600 mb-2" id="header-title">Zugriff erforderlich</h1>
            <p class="text-center text-gray-500 mb-6" id="lockout-text">Bitte geben Sie das erforderliche Passwort ein.</p>

            <!-- Konfigurationsfehler-Meldung (jetzt nur bei leerem Fallback sichtbar) -->
            <div id="config-error" class="bg-red-50 border-l-4 border-red-400 text-red-700 p-4 mb-6 rounded-lg hidden">
                <p class="font-bold">Konfigurationsfehler: Passwort fehlt</p>
                <p>Bitte tragen Sie das Passwort direkt im Code (in der Variablen `HARDCODED_SECRET_FALLBACK`) ein, da die Umgebungsvariable nicht übergeben wird.</p>
                <p class="mt-2 text-sm text-red-800">Aktueller Status: <span id="debug-status" class="font-mono bg-red-200 px-1 py-0.5 rounded text-red-900"></span></p>
            </div>

            <form id="password-form" onsubmit="checkPassword(event)">
                <div class="mb-4">
                    <label for="password-input" class="block text-sm font-medium text-gray-700 mb-1">Passwort</label>
                    <input type="password" id="password-input" required autocomplete="off"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm"
                           placeholder="••••••••">
                </div>
                
                <p id="error-message" class="text-red-600 text-sm mb-4 hidden font-medium text-center">Falsches Passwort. (Versuche verbleibend: <span id="attempts-left">3</span>)</p>

                <button type="submit" id="submit-button"
                        class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200 shadow-md shadow-indigo-500/50 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
                    Zugriff gewähren
                </button>
            </form>
        </div>
    </div>

    <!-- 2. Geschützte Inhaltsansicht (Fullscreen Tabelle) -->
    <div id="content-view" class="hidden full-screen-content flex flex-col bg-gray-900 text-white">
        <header class="p-4 sm:p-6 flex justify-between items-center bg-gray-800 shadow-lg">
            <div>
                <h1 class="text-2xl sm:text-3xl font-extrabold text-indigo-400">Vertrauliche Datenübersicht</h1>
                <p class="text-gray-400 mt-1 text-sm">Datenblatt wird im Hintergrund alle 5 Sekunden aktualisiert.</p>
            </div>
            <button onclick="logOut()" 
                    class="ml-4 px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition duration-150 shadow-md">
                Abmelden & Sperren
            </button>
        </header>
        
        <!-- Google Sheets Einbettung (Fullscreen) -->
        <div class="flex-grow iframe-container">
            <iframe id="sheet-iframe" title="Eingebettetes Google Sheet" 
                    src="" allowfullscreen>
            </iframe>
        </div>
    </div>

    <script>
        // ====================================================================
        // WICHTIGE KONFIGURATION
        // ====================================================================
        
        // !!! AKTION ERFORDERLICH !!!
        // Da die Umgebungsvariable SECRET_PASSWORD nicht im Browser ankommt, 
        // muss das Passwort hier als Notfall-Fallback hinterlegt werden.
        // ERSETZEN SIE DEN PLATZHALTER mit Ihrem Passwort (als String).
        const HARDCODED_SECRET_FALLBACK = 'YOUR_SECRET_RENDER_PASSWORD_HERE'; 

        // Google Sheets Embed URL für die Freigabeansicht
        const SHEET_EMBED_URL = 'https://docs.google.com/spreadsheets/u/0/d/10um-Jwoayka_kPFUsnQkCmm7pMq0Z2qK2ptVIjenWMw/htmlview';
        
        // Passwörter und Lockout-Regeln
        const MAX_ATTEMPTS = 3;
        
        // Auslesen der Umgebungsvariable (die nicht funktioniert)
        const SECRET_VARIABLE_NAME = 'SECRET_PASSWORD'; 
        const INJECTED_SECRET = window[SECRET_VARIABLE_NAME];

        // Die App verwendet zuerst die injizierte Variable, falls vorhanden, 
        // ansonsten den hartkodierten Fallback.
        const REQUIRED_PASSWORD = (
            typeof INJECTED_SECRET !== 'undefined' && 
            INJECTED_SECRET !== null && 
            String(INJECTED_SECRET).trim() !== ''
        ) ? String(INJECTED_SECRET).trim() : (HARDCODED_SECRET_FALLBACK.trim() !== 'YOUR_SECRET_RENDER_PASSWORD_HERE' ? HARDCODED_SECRET_FALLBACK.trim() : null);
        
        // Lokale Speicherschlüssel
        const ATTEMPTS_KEY = 'auth_attempts';          
        const LOCKOUT_KEY = 'lockout_until';          
        const LOCKOUT_COUNT_KEY = 'lockout_count';    
        const SESSION_AUTH_KEY = 'is_authenticated';  
        
        let refreshInterval = null;
        let lockoutTimer = null;

        // ====================================================================
        // HILFSFUNKTIONEN
        // ====================================================================

        /**
         * Berechnet die progressive Dauer basierend auf der Anzahl der Lockouts.
         */
        function getProgressiveLockoutDuration(count) {
            const baseDuration = 30000; // 30 Sekunden
            return baseDuration * Math.pow(2, count - 1); 
        }

        // ====================================================================
        // UI- & VIEW-FUNKTIONEN
        // ====================================================================

        function showView(viewId) {
            document.getElementById('password-view').classList.add('hidden');
            document.getElementById('content-view').classList.add('hidden');
            
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.remove('hidden');
            }

            // Dynamischer HTML-Titel
            if (viewId === 'password-view') {
                const lockoutUntil = parseInt(localStorage.getItem(LOCKOUT_KEY) || '0', 10);
                if (Date.now() < lockoutUntil) {
                    document.title = "Zugriff GESPERRT";
                } else if (REQUIRED_PASSWORD === null) {
                    document.title = "Fehler: Passwort fehlt";
                } else {
                    document.title = "Passwort erforderlich";
                }
            } else if (viewId === 'content-view') {
                document.title = "Geschützte Datenansicht (Eingeloggt)";
            }
        }

        /**
         * Führt einen "unsichtbaren" Refresh des iFrames durch.
         */
        function refreshSheet() {
            const iframe = document.getElementById('sheet-iframe');
            iframe.src = SHEET_EMBED_URL;
        }

        function startRefreshLoop() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshSheet(); 
            refreshInterval = setInterval(refreshSheet, 5000); 
        }

        function stopRefreshLoop() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = null;
        }

        // ====================================================================
        // LOCKOUT- & AUTHENTIFIZIERUNGS-LOGIK
        // ====================================================================

        /**
         * Prüft, ob der Benutzer gesperrt oder das Passwort konfiguriert ist.
         * @returns {boolean} True, wenn gesperrt oder Konfigurationsfehler vorliegt.
         */
        function checkLockout() {
            const lockoutUntil = parseInt(localStorage.getItem(LOCKOUT_KEY) || '0', 10);
            const lockoutCount = parseInt(localStorage.getItem(LOCKOUT_COUNT_KEY) || '0', 10);
            const now = Date.now();
            const isLocked = now < lockoutUntil;

            const form = document.getElementById('password-form');
            const lockoutText = document.getElementById('lockout-text');
            const configError = document.getElementById('config-error');
            const debugEl = document.getElementById('debug-status');
            const errorMsg = document.getElementById('error-message');


            // 1. Konfigurationsprüfung
            if (REQUIRED_PASSWORD === null) {
                form.classList.add('hidden');
                errorMsg.classList.add('hidden');
                configError.classList.remove('hidden');
                document.getElementById('header-title').textContent = "Konfiguration UNVOLLSTÄNDIG";
                lockoutText.classList.add('hidden');
                
                // Debugging-Anzeige aktualisieren
                let status = "Wird geprüft...";
                if (INJECTED_SECRET) {
                    status = `Gefunden (Injected): Ja (Länge: ${String(INJECTED_SECRET).trim().length})`;
                } else if (HARDCODED_SECRET_FALLBACK.trim() !== 'YOUR_SECRET_RENDER_PASSWORD_HERE') {
                    status = `Gefunden (Hardcoded): Ja (Länge: ${HARDCODED_SECRET_FALLBACK.trim().length})`;
                } else {
                    status = `FEHLER: Platzhalter ('YOUR_SECRET_RENDER_PASSWORD_HERE') ist noch gesetzt.`;
                }

                if (debugEl) debugEl.textContent = status;
                
                return true; // Blockiert den Zugriff
            } else {
                // Konfiguration OK
                form.classList.remove('hidden');
                configError.classList.add('hidden');
                lockoutText.classList.remove('hidden');
            }


            // 2. Lockout-Prüfung (unverändert)
            if (isLocked) {
                const lockoutCount = parseInt(localStorage.getItem(LOCKOUT_COUNT_KEY) || '0', 10);

                form.classList.add('hidden');
                errorMsg.classList.add('hidden');
                document.getElementById('header-title').textContent = "Zugriff GESPERRT";
                lockoutText.classList.remove('text-gray-500');
                lockoutText.classList.add('text-red-600', 'font-bold');
                
                const updateCountdown = () => {
                    const newLockoutUntil = parseInt(localStorage.getItem(LOCKOUT_KEY) || '0', 10);
                    const newNow = Date.now();
                    const remainingSeconds = Math.ceil((newLockoutUntil - newNow) / 1000);
                    
                    if (remainingSeconds <= 0) {
                        clearInterval(lockoutTimer);
                        lockoutTimer = null;
                        localStorage.removeItem(LOCKOUT_KEY);
                        localStorage.removeItem(ATTEMPTS_KEY);
                        initApp(); 
                    } else {
                        lockoutText.innerHTML = `Zugriff gesperrt für <span class="underline decoration-dashed">${remainingSeconds}</span> Sekunden (Versuche: ${lockoutCount}x).`;
                        document.title = `Zugriff GESPERRT (${remainingSeconds}s)`;
                    }
                };

                if (!lockoutTimer) {
                    lockoutTimer = setInterval(updateCountdown, 1000);
                }
                updateCountdown(); 

                return true;
            } else {
                if (lockoutTimer) {
                    clearInterval(lockoutTimer);
                    lockoutTimer = null;
                }
                
                const currentAttempts = parseInt(localStorage.getItem(ATTEMPTS_KEY) || '0', 10);
                const attemptsLeft = MAX_ATTEMPTS - currentAttempts;

                document.getElementById('password-input').disabled = false;
                document.getElementById('submit-button').disabled = false;
                document.getElementById('header-title').textContent = "Zugriff erforderlich";
                lockoutText.classList.remove('text-red-600', 'font-bold');
                lockoutText.classList.add('text-gray-500');
                lockoutText.textContent = "Bitte geben Sie das erforderliche Passwort ein.";
                
                const attemptsEl = document.getElementById('attempts-left');
                if (attemptsEl) attemptsEl.textContent = attemptsLeft;
                
                return false;
            }
        }

        /**
         * Verarbeitet die Passworteingabe.
         */
        window.checkPassword = function(event) {
            event.preventDefault();
            
            // Abbrechen, wenn Konfigurationsfehler oder Lockout.
            if (REQUIRED_PASSWORD === null || checkLockout()) return; 
            
            const inputEl = document.getElementById('password-input');
            const input = inputEl.value;
            const errorMessage = document.getElementById('error-message');
            
            // Passwort ist korrekt
            if (input === REQUIRED_PASSWORD) {
                errorMessage.classList.add('hidden');
                
                localStorage.setItem(SESSION_AUTH_KEY, 'true'); 
                localStorage.setItem(ATTEMPTS_KEY, '0');
                localStorage.setItem(LOCKOUT_COUNT_KEY, '0'); 
                localStorage.removeItem(LOCKOUT_KEY);
                
                inputEl.value = ''; 
                
                showView('content-view');
                startRefreshLoop();
                
            } 
            // Passwort ist falsch
            else {
                let currentAttempts = parseInt(localStorage.getItem(ATTEMPTS_KEY) || '0', 10);
                currentAttempts++;
                localStorage.setItem(ATTEMPTS_KEY, currentAttempts.toString());

                const attemptsLeft = MAX_ATTEMPTS - currentAttempts;

                if (currentAttempts >= MAX_ATTEMPTS) {
                    let lockoutCount = parseInt(localStorage.getItem(LOCKOUT_COUNT_KEY) || '0', 10);
                    lockoutCount++;
                    localStorage.setItem(LOCKOUT_COUNT_KEY, lockoutCount.toString());

                    const lockoutDuration = getProgressiveLockoutDuration(lockoutCount);
                    const lockoutUntil = Date.now() + lockoutDuration;
                    localStorage.setItem(LOCKOUT_KEY, lockoutUntil.toString());
                    
                    checkLockout(); 
                    
                } else {
                    errorMessage.classList.remove('hidden');
                    document.getElementById('attempts-left').textContent = attemptsLeft;
                }
            }
        }

        /**
         * Setzt den permanenten Login-Status zurück.
         */
        window.logOut = function() {
            if (confirm("Sind Sie sicher, dass Sie sich abmelden möchten? Der Login-Status wird gelöscht.")) {
                stopRefreshLoop();
                localStorage.removeItem(SESSION_AUTH_KEY); 
                document.getElementById('password-input').value = '';
                initApp(); 
            }
        }

        /**
         * Initialisiert die Anwendung.
         */
        function initApp() {
            // 1. Ladebildschirm ausblenden
            document.getElementById('loading-view').classList.add('opacity-0');
            setTimeout(() => document.getElementById('loading-view').classList.add('hidden'), 300);

            // 2. Zustand prüfen (Konfiguration / Lockout / Authentifizierung)
            const isAuthenticated = localStorage.getItem(SESSION_AUTH_KEY) === 'true';

            if (isAuthenticated && REQUIRED_PASSWORD !== null) {
                showView('content-view');
                startRefreshLoop();
            } else {
                showView('password-view');
                checkLockout(); 
            }
        }

        // App starten, sobald das Fenster geladen ist
        window.onload = initApp;
        
    </script>
</body>
</html>
