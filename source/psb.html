<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Lade Anwendung...</title>
    <!-- Tailwind CSS CDN für modernes Design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Angepasste Schriftart und Fullscreen-Layout */
        body { font-family: 'Inter', sans-serif; }
        .full-screen-content { min-height: 100vh; width: 100%; }
        /* Platz für Header/Button lassen */
        .iframe-container {
            width: 100%;
            height: calc(100vh - 120px); 
            overflow: hidden;
            position: relative;
        }
        /* Style, um den iframe immer im Fullscreen des Containers zu halten */
        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 overflow-hidden">

    <!-- Ladebildschirm/Overlay (sollte schnell verschwinden) -->
    <div id="loading-view" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50 transition-opacity duration-300 opacity-100">
        <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4 text-lg font-medium text-gray-600">Lade Anwendung...</p>
    </div>

    <!-- 1. Passwort-Eingabeansicht -->
    <div id="password-view" class="hidden full-screen-content flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl border border-gray-100">
            <h1 class="text-3xl font-extrabold text-center text-indigo-600 mb-2" id="header-title">Zugriff erforderlich</h1>
            <p class="text-center text-gray-500 mb-6" id="lockout-text">Bitte geben Sie das erforderliche Passwort ein.</p>

            <form id="password-form" onsubmit="checkPassword(event)">
                <div class="mb-4">
                    <label for="password-input" class="block text-sm font-medium text-gray-700 mb-1">Passwort</label>
                    <input type="password" id="password-input" required autocomplete="off"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm"
                           placeholder="••••••••">
                </div>
                
                <p id="error-message" class="text-red-600 text-sm mb-4 hidden font-medium text-center">Falsches Passwort. (Versuche verbleibend: <span id="attempts-left">3</span>)</p>

                <button type="submit" id="submit-button"
                        class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200 shadow-md shadow-indigo-500/50 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
                    Zugriff gewähren
                </button>
            </form>
        </div>
    </div>

    <!-- 2. Geschützte Inhaltsansicht (Fullscreen Tabelle) -->
    <div id="content-view" class="hidden full-screen-content flex flex-col bg-gray-900 text-white">
        <header class="p-4 sm:p-6 flex justify-between items-center bg-gray-800 shadow-lg">
            <div>
                <h1 class="text-2xl sm:text-3xl font-extrabold text-indigo-400">Vertrauliche Datenübersicht</h1>
                <p class="text-gray-400 mt-1 text-sm">Datenblatt wird im Hintergrund alle 5 Sekunden aktualisiert.</p>
            </div>
            <button onclick="logOut()" 
                    class="ml-4 px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition duration-150 shadow-md">
                Abmelden & Sperren
            </button>
        </header>
        
        <!-- Google Sheets Einbettung (Fullscreen) -->
        <div class="flex-grow iframe-container">
            <iframe id="sheet-iframe" title="Eingebettetes Google Sheet" 
                    src="" allowfullscreen>
            </iframe>
        </div>
    </div>

    <script>
        // ====================================================================
        // KONSTANTEN und INITIALISIERUNG
        // ====================================================================
        
        // Google Sheets Embed URL für die Freigabeansicht
        const SHEET_EMBED_URL = 'https://docs.google.com/spreadsheets/u/0/d/10um-Jwoayka_kPFUsnQkCmm7pMq0Z2qK2ptVIjenWMw/htmlview';
        
        // Passwörter und Lockout-Regeln
        const HARDCODED_PASSWORD = "mein_geheimes_passwort"; 
        const MAX_ATTEMPTS = 3;
        
        // Passworteinstellung: Priorisiert Umgebungsvariable, falls vorhanden
        const SECRET_PASSWORD = (typeof window.SECRET_PASSWORD !== 'undefined' ? window.SECRET_PASSWORD : HARDCODED_PASSWORD);

        // Lokale Speicherschlüssel
        const ATTEMPTS_KEY = 'auth_attempts';          // Zählt die Fehlversuche (0 bis MAX_ATTEMPTS)
        const LOCKOUT_KEY = 'lockout_until';          // Zeitstempel, bis wann gesperrt ist (wird persistent gespeichert)
        const LOCKOUT_COUNT_KEY = 'lockout_count';    // Wie oft der Lockout ausgelöst wurde (für progressive Timeouts)
        const SESSION_AUTH_KEY = 'is_authenticated';  // Speichert den erfolgreichen Login permanent
        
        let refreshInterval = null;
        let lockoutTimer = null;

        // ====================================================================
        // HILFSFUNKTIONEN
        // ====================================================================

        /**
         * Berechnet die progressive Dauer basierend auf der Anzahl der Lockouts.
         * 1. Lockout: 30s, 2. Lockout: 60s, 3. Lockout: 120s, 4. Lockout: 240s...
         * @param {number} count - Wie oft der Lockout bereits ausgelöst wurde.
         * @returns {number} Dauer in Millisekunden.
         */
        function getProgressiveLockoutDuration(count) {
            const baseDuration = 30000; // 30 Sekunden
            return baseDuration * Math.pow(2, count - 1);
        }

        // ====================================================================
        // UI- & VIEW-FUNKTIONEN
        // ====================================================================

        function showView(viewId) {
            document.getElementById('password-view').classList.add('hidden');
            document.getElementById('content-view').classList.add('hidden');
            
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.remove('hidden');
            }

            // Dynamischer HTML-Titel
            if (viewId === 'password-view') {
                const lockoutUntil = parseInt(localStorage.getItem(LOCKOUT_KEY) || '0', 10);
                if (Date.now() < lockoutUntil) {
                    document.title = "Zugriff GESPERRT";
                } else {
                    document.title = "Passwort erforderlich";
                }
            } else if (viewId === 'content-view') {
                document.title = "Geschützte Datenansicht (Eingeloggt)";
            }
        }

        /**
         * Führt einen "unsichtbaren" Refresh des iFrames durch, indem die Src-URL neu gesetzt wird.
         */
        function refreshSheet() {
            const iframe = document.getElementById('sheet-iframe');
            
            // Um Cache-Probleme zu vermeiden, setzen wir die src neu
            iframe.src = SHEET_EMBED_URL;
        }

        function startRefreshLoop() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshSheet(); // Erste Aktualisierung sofort durchführen
            // Loop starten: Aktualisierung alle 5 Sekunden
            refreshInterval = setInterval(refreshSheet, 5000); 
        }

        function stopRefreshLoop() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = null;
        }

        // ====================================================================
        // LOCKOUT- & AUTHENTIFIZIERUNGS-LOGIK
        // ====================================================================

        /**
         * Prüft, ob der Benutzer gesperrt ist und aktualisiert die UI/Titel.
         * @returns {boolean} True, wenn gesperrt.
         */
        function checkLockout() {
            const lockoutUntil = parseInt(localStorage.getItem(LOCKOUT_KEY) || '0', 10);
            const lockoutCount = parseInt(localStorage.getItem(LOCKOUT_COUNT_KEY) || '0', 10);
            const now = Date.now();
            const isLocked = now < lockoutUntil;

            const form = document.getElementById('password-form');
            const button = document.getElementById('submit-button');
            const lockoutText = document.getElementById('lockout-text');
            const errorMsg = document.getElementById('error-message');

            if (isLocked) {
                const duration = getProgressiveLockoutDuration(lockoutCount);
                const durationSeconds = Math.round(duration / 1000);

                // UI für Sperrung vorbereiten
                form.classList.add('hidden');
                errorMsg.classList.add('hidden');
                document.getElementById('header-title').textContent = "Zugriff GESPERRT";
                lockoutText.classList.remove('text-gray-500');
                lockoutText.classList.add('text-red-600', 'font-bold');
                
                // Countdown-Timer starten/aktualisieren
                const updateCountdown = () => {
                    const newLockoutUntil = parseInt(localStorage.getItem(LOCKOUT_KEY) || '0', 10);
                    const newNow = Date.now();
                    const remainingSeconds = Math.ceil((newLockoutUntil - newNow) / 1000);
                    
                    if (remainingSeconds <= 0) {
                        clearInterval(lockoutTimer);
                        lockoutTimer = null;
                        localStorage.removeItem(LOCKOUT_KEY);
                        localStorage.removeItem(ATTEMPTS_KEY);
                        initApp(); // Neu initialisieren, um das Formular anzuzeigen
                    } else {
                        lockoutText.innerHTML = `Zugriff gesperrt für <span class="underline decoration-dashed">${remainingSeconds}</span> Sekunden (Fehler: ${lockoutCount}/${durationSeconds}s).`;
                        document.title = `Zugriff GESPERRT (${remainingSeconds}s)`;
                    }
                };

                // Wenn Timer noch nicht läuft, starten
                if (!lockoutTimer) {
                    lockoutTimer = setInterval(updateCountdown, 1000);
                }
                updateCountdown(); // Sofort aktualisieren

                return true;
            } else {
                // Sperrung ist abgelaufen oder nicht vorhanden
                if (lockoutTimer) {
                    clearInterval(lockoutTimer);
                    lockoutTimer = null;
                }
                
                const currentAttempts = parseInt(localStorage.getItem(ATTEMPTS_KEY) || '0', 10);
                const attemptsLeft = MAX_ATTEMPTS - currentAttempts;

                // UI für normale Abfrage zurücksetzen
                form.classList.remove('hidden');
                button.disabled = false;
                document.getElementById('header-title').textContent = "Zugriff erforderlich";
                lockoutText.classList.remove('text-red-600', 'font-bold');
                lockoutText.classList.add('text-gray-500');
                lockoutText.textContent = "Bitte geben Sie das erforderliche Passwort ein.";
                
                const attemptsEl = document.getElementById('attempts-left');
                if (attemptsEl) attemptsEl.textContent = attemptsLeft;
                
                return false;
            }
        }

        /**
         * Verarbeitet die Passworteingabe und Lockout-Zähler.
         */
        window.checkPassword = function(event) {
            event.preventDefault();
            
            if (checkLockout()) return; 
            
            const inputEl = document.getElementById('password-input');
            const input = inputEl.value;
            const errorMessage = document.getElementById('error-message');
            
            // Passwort ist korrekt
            if (input === SECRET_PASSWORD) {
                errorMessage.classList.add('hidden');
                
                // Persistente Speicherung des Logins
                localStorage.setItem(SESSION_AUTH_KEY, 'true'); 
                
                // Zähler und Lockout-Status zurücksetzen
                localStorage.setItem(ATTEMPTS_KEY, '0');
                localStorage.setItem(LOCKOUT_COUNT_KEY, '0'); 
                localStorage.removeItem(LOCKOUT_KEY);
                
                inputEl.value = ''; 
                
                showView('content-view');
                startRefreshLoop();
                
            } 
            // Passwort ist falsch
            else {
                let currentAttempts = parseInt(localStorage.getItem(ATTEMPTS_KEY) || '0', 10);
                currentAttempts++;
                localStorage.setItem(ATTEMPTS_KEY, currentAttempts.toString());

                const attemptsLeft = MAX_ATTEMPTS - currentAttempts;

                if (currentAttempts >= MAX_ATTEMPTS) {
                    // Lockout Zähler erhöhen und Sperrzeit festlegen
                    let lockoutCount = parseInt(localStorage.getItem(LOCKOUT_COUNT_KEY) || '0', 10);
                    lockoutCount++;
                    localStorage.setItem(LOCKOUT_COUNT_KEY, lockoutCount.toString());

                    const lockoutDuration = getProgressiveLockoutDuration(lockoutCount);
                    const lockoutUntil = Date.now() + lockoutDuration;
                    localStorage.setItem(LOCKOUT_KEY, lockoutUntil.toString());
                    
                    // UI aktualisieren (zeigt den Countdown)
                    checkLockout(); 
                    
                } else {
                    // Fehler anzeigen und Zähler aktualisieren
                    errorMessage.classList.remove('hidden');
                    document.getElementById('attempts-left').textContent = attemptsLeft;
                }
            }
        }

        /**
         * Setzt den permanenten Login-Status zurück und sperrt die Ansicht.
         */
        window.logOut = function() {
             // Verwende eine benutzerdefinierte Meldung statt window.confirm()
            if (confirm("Sind Sie sicher, dass Sie sich abmelden möchten? Der Login-Status wird gelöscht.")) {
                stopRefreshLoop();
                localStorage.removeItem(SESSION_AUTH_KEY); // Permanenten Login-Status löschen
                
                // Das Eingabefeld leeren
                document.getElementById('password-input').value = '';
                
                // Nach Abmeldung sofort Lockout prüfen und Passwort-View zeigen
                initApp(); 
            }
        }

        /**
         * Initialisiert die Anwendung und prüft den Authentifizierungsstatus.
         */
        function initApp() {
            // 1. Ladebildschirm ausblenden
            document.getElementById('loading-view').classList.add('opacity-0');
            setTimeout(() => document.getElementById('loading-view').classList.add('hidden'), 300);

            // 2. Session-Status prüfen
            const isAuthenticated = localStorage.getItem(SESSION_AUTH_KEY) === 'true';

            if (isAuthenticated) {
                showView('content-view');
                startRefreshLoop();
            } else {
                // 3. Lockout-Status prüfen (wird auch im Falle einer Sperrung die UI updaten)
                showView('password-view');
                checkLockout(); 
            }
        }

        // App starten, sobald das Fenster geladen ist
        window.onload = initApp;
        
    </script>
</body>
</html>
 